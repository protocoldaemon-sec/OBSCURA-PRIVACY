<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple WOTS+ Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #0a0a0f; color: white; }
        .result { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #1a4a1a; border: 1px solid #4a8a4a; }
        .error { background: #4a1a1a; border: 1px solid #8a4a4a; }
        button { padding: 10px 20px; background: #4a4a8a; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #6a6aaa; }
        pre { background: #1a1a1a; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üß™ Simple WOTS+ Test</h1>
    
    <button onclick="testImport()">Test Import</button>
    <button onclick="testWOTSGeneration()">Test WOTS+ Generation</button>
    <button onclick="testFetch()">Test Backend Fetch</button>
    
    <div id="results"></div>

    <script type="module">
        let WOTS, ByteUtils;
        
        window.testImport = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">üß™ Testing WOTS+ import...</div>';
            
            try {
                console.log('Loading WOTS+ library via dynamic import...');
                
                // Try dynamic import from CDN
                const module = await import('https://unpkg.com/mochimo-wots-v2@1.1.1/dist/index.es.js');
                WOTS = module.WOTS;
                ByteUtils = module.ByteUtils;
                
                if (!WOTS || !ByteUtils) {
                    throw new Error('WOTS or ByteUtils is undefined');
                }
                
                // Test basic functionality
                if (typeof WOTS.wots_pkgen !== 'function') {
                    throw new Error('WOTS.wots_pkgen is not a function');
                }
                
                if (typeof ByteUtils.uint8ArrayToHex !== 'function') {
                    throw new Error('ByteUtils.uint8ArrayToHex is not a function');
                }
                
                resultsDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ Import Test Successful!</h3>
                        <p>WOTS: ${typeof WOTS}</p>
                        <p>ByteUtils: ${typeof ByteUtils}</p>
                        <p>wots_pkgen: ${typeof WOTS.wots_pkgen}</p>
                        <p>wots_sign: ${typeof WOTS.wots_sign}</p>
                        <p>uint8ArrayToHex: ${typeof ByteUtils.uint8ArrayToHex}</p>
                    </div>
                `;
                
                // Store for other tests
                window.WOTS = WOTS;
                window.ByteUtils = ByteUtils;
                
            } catch (error) {
                console.error('‚ùå Import test failed:', error);
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Import Test Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        };
        
        window.testWOTSGeneration = async function() {
            const resultsDiv = document.getElementById('results');
            
            if (!WOTS || !ByteUtils) {
                resultsDiv.innerHTML = '<div class="result error">‚ùå Please run Import Test first</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="result">üß™ Testing WOTS+ generation...</div>';
            
            try {
                console.log('Starting WOTS+ generation test...');
                
                // Generate random secret (32 bytes)
                const secret = new Uint8Array(32);
                crypto.getRandomValues(secret);

                // Generate deterministic seeds
                const pubSeed = new Uint8Array(32);
                crypto.getRandomValues(pubSeed);
                
                const rnd2 = new Uint8Array(32);
                crypto.getRandomValues(rnd2);

                console.log('‚úÖ Generated seeds');

                // Generate public key (2144 bytes)
                const publicKey = new Uint8Array(2144);
                console.log('Calling WOTS.wots_pkgen...');
                WOTS.wots_pkgen(publicKey, secret, pubSeed, 0, rnd2);

                console.log('‚úÖ Generated public key, length:', publicKey.length);

                // Create full address (2208 bytes)
                const address = new Uint8Array(2208);
                address.set(publicKey, 0);
                address.set(pubSeed, 2144);
                address.set(rnd2, 2176);

                // Convert to hex
                console.log('Converting to hex...');
                const addressHex = ByteUtils.uint8ArrayToHex(address);
                console.log('‚úÖ Address hex conversion, length:', addressHex.length);

                // Test message signing
                const message = 'Hello, WOTS+ test!';
                const messageBytes = new TextEncoder().encode(message);

                // Generate signature (2144 bytes)
                const signature = new Uint8Array(2144);
                console.log('Calling WOTS.wots_sign...');
                WOTS.wots_sign(signature, messageBytes, secret, pubSeed, 0, rnd2);

                // Convert signature to hex
                const signatureHex = ByteUtils.uint8ArrayToHex(signature);
                
                const result = {
                    publicKeyLength: addressHex.length,
                    publicKeyValid: addressHex.length === 4416,
                    signatureLength: signatureHex.length,
                    signatureValid: signatureHex.length === 4288,
                    message: message,
                    publicKeyPreview: addressHex.slice(0, 64) + '...',
                    signaturePreview: signatureHex.slice(0, 64) + '...'
                };
                
                console.log('‚úÖ WOTS+ generation successful:', result);
                
                resultsDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ WOTS+ Generation Test Successful!</h3>
                        <p><strong>Public Key:</strong> ${result.publicKeyLength} chars ${result.publicKeyValid ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>Signature:</strong> ${result.signatureLength} chars ${result.signatureValid ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>Message:</strong> ${result.message}</p>
                        <p><strong>Public Key Preview:</strong> ${result.publicKeyPreview}</p>
                        <p><strong>Signature Preview:</strong> ${result.signaturePreview}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå WOTS+ generation test failed:', error);
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå WOTS+ Generation Test Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        };
        
        window.testFetch = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">üß™ Testing backend fetch...</div>';
            
            try {
                const response = await fetch('http://localhost:3000/health');
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ Backend Fetch Test Successful!</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Backend fetch test failed:', error);
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Backend Fetch Test Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        };
        
        // Auto-run import test when page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                console.log('Auto-running import test...');
                testImport();
            }, 1000);
        });
    </script>
</body>
</html>